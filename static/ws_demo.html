<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Live Feed</title>
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f1724;
            --text: #e6eef6;
            --accent: #38bdf8;
            --success: #4ade80;
            --error: #f87171;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 24px;
        }

        .container { 
            width: 100%;
            max-width: 800px; 
        }

        .card { 
            background: var(--card); 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 { margin: 0; font-size: 1.5rem; }

        #status { 
            font-size: 0.85rem; 
            padding: 4px 12px; 
            border-radius: 20px; 
            background: rgba(0,0,0,0.2);
            font-weight: 600;
        }

        .status-online { color: var(--success); border: 1px solid var(--success); }
        .status-offline { color: var(--error); border: 1px solid var(--error); }

        #log { 
            height: 500px; 
            overflow-y: auto; 
            background: #07111a; 
            padding: 10px; 
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item { 
            padding: 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .ts { color: #8fb2d9; font-size: 12px; margin-bottom: 4px; }
        .loc { font-weight: 700; color: var(--accent); }
        b { color: #fff; }

        /* Custom Scrollbar */
        #log::-webkit-scrollbar { width: 6px; }
        #log::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <header>
            <h2>Live Predictions</h2>
            <div id="status" class="status-offline">DISCONNECTED</div>
        </header>
        
        <div id="log"></div>
    </div>
</div>

<script>
    const log = document.getElementById('log');
    const status = document.getElementById('status');
    
    // Config: Change this if your server is on a different port/IP
    const WS_ENDPOINT = "ws://127.0.0.1:8000/ws";
    let socket = null;

    function connect() {
        socket = new WebSocket(WS_ENDPOINT);

        socket.onopen = () => {
            console.log("Connected to Stream");
            status.textContent = "● LIVE";
            status.className = "status-online";
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                addEntryToLog(data);
            } catch (err) {
                console.error("Data error:", err);
            }
        };

        socket.onclose = () => {
            status.textContent = "○ RECONNECTING...";
            status.className = "status-offline";
            // Try to reconnect every 3 seconds
            setTimeout(connect, 3000);
        };

        socket.onerror = (err) => {
            console.error("Socket Error:", err);
            socket.close();
        };
    }

    function addEntryToLog(data) {
        const div = document.createElement('div');
        div.className = 'item';
        
        // Human-friendly fallback if keys are missing
        const time = data.ts || new Date().toLocaleTimeString();
        const location = data.location || "Unknown Station";
        const flow = data.predicted_flow ?? "N/A";
        const confidence = data.confidence ?? "N/A";

        div.innerHTML = `
            <div class="ts">${time}</div>
            <div>
                <span class="loc">${location}</span> — 
                Flow: <b>${flow}</b> | Conf: <b>${confidence}</b>
            </div>
        `;

        // Add to top of the list
        log.prepend(div);

        // Auto-cleanup: remove oldest items if list exceeds 50
        if (log.children.length > 50) {
            log.removeChild(log.lastChild);
        }
    }

    // Start connection on page load
    connect();
</script>

</body>
</html>